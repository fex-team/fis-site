<!DOCTYPE html><html lang="zhCN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="_FIS_构建工具_前端工具框架"><meta name="keywords" content=",百度前端团队,FIS,百度FIS,百度前端,fis,前端模块化,前端工程,性能优化,web performance"><title>插件开发</title><meta name="author" content="fis team"><!-- Enable responsive viewport --><meta name="viewport" content="width=device-width,initial-scale=1"><link href="/assets/themes/css/normalize.css" rel="stylesheet"><link href="/assets/themes/css/main.css" rel="stylesheet"><!-- Custom styles --><link href="/assets/themes/css/style.css?body=1" rel="stylesheet" type="text/css" media="all"><!--<link href="/assets/themes//css/highlight/monokai_sublime.css" rel="stylesheet" type="text/css" media="all">--><link href="/assets/themes/css/pygments/github.css" rel="stylesheet" type="text/css" media="all"><link href="/assets/themes/css/perfect-scrollbar.min.css" rel="stylesheet"><link href="assets/css/font-awesome.min.css" rel="stylesheet" type="text/css" media="all"><script type="text/javascript"></script><!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries --><!-- WARNING: Respond.js doesn't work if you view the page via file:// --><!--[if lt IE 9]>
    <script src="/assets/themes/js/html5shiv.js"></script>
    <script src="/assets/themes/js/respond.min.js"></script>
    <![endif]--><!-- Fav and touch icons --><!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    --><script src="/assets/themes/js/jquery.min.js"></script><script src="/assets/themes/js/scrollspy.js"></script></head><body><header class="navbar"><section><a href="/fis-site/index.html"><div class="logo"><i class="fa fa-cogs"></i> F.I.S - 前端工具框架</div></a><div class="nav-items"><a href="/fis-site/index.html"><div class="nav-item">首页</div></a> <a href="/fis-site/docs/beginning/getting-started.html"><div class="nav-item">使用文档</div></a> <a href="http://oak.baidu.com"><div class="nav-item">解决方案</div></a> <a target="_blank" href="http://www.imooc.com/learn/220"><div class="nav-item">在线课程</div></a> <a target="_blank" href="http://fex.baidu.com"><div class="nav-item">FEX官网</div></a></div></section></header><div id="wrap"><aside><nav class="sidebar"><ul><li class="item-category"><a href="/fis-site/docs/beginning/getting-started.html">快速入门</a></li><li class="item-sub"><a href="/fis-site/docs/beginning/getting-started.html#optimize">资源压缩</a></li><li class="item-sub"><a href="/fis-site/docs/beginning/getting-started.html#combine">资源合并</a></li><li class="item-sub"><a href="/fis-site/docs/beginning/assist.html">辅助开发</a></li><li class="item-sub"><a href="/fis-site/docs/api/cli.html">命令行</a></li><li class="item-category"><span>进阶使用</span></li><li class="item-sub"><a href="/fis-site/docs/more/fis-standard.html#资源定位">资源定位</a></li><li class="item-sub"><a href="/fis-site/docs/more/fis-standard.html#内容嵌入">内容嵌入</a></li><li class="item-sub"><a href="/fis-site/docs/more/fis-standard.html#依赖声明">依赖声明</a></li><li class="item-sub"><a href="/fis-site/docs/advance/roadmap.html">roadmap详解</a></li><li class="item-sub"><a href="/fis-site/docs/advance/modjs-solution.html">前端模块化</a></li><li class="item-sub"><a href="/fis-site/docs/advance/plugin-list.html">更多插件</a></li><li class="item-category"><a href="/fis-site/docs/dev/intro.html">二次开发</a></li><li class="item-sub"><a href="/fis-site/docs/dev/plugin.html">插件开发</a></li><li class="item-sub"><a href="/fis-site/docs/dev/solution.html">解决方案封装</a></li><li class="item-category"><a href="/fis-site/docs/dev/more.html">更多文档</a></li><li class="item-category"><a href="/fis-site/docs/api/fis-conf.html">配置API</a></li><li class="item-sub"><a href="/fis-site/docs/api/fis-conf.html">配置文件</a></li><li class="item-sub"><a href="/fis-site/docs/api/fis-conf.html#project">project</a></li><li class="item-sub"><a href="/fis-site/docs/api/fis-conf.html#modules">modules</a></li><li class="item-sub"><a href="/fis-site/docs/api/fis-conf.html#settings">settings</a></li><li class="item-sub"><a href="/fis-site/docs/api/fis-conf.html#roadmap">roadmap</a></li><li class="item-sub"><a href="/fis-site/docs/api/fis-conf.html#pack">pack</a></li><li class="item-sub"><a href="/fis-site/docs/api/fis-conf.html#deploy">deploy</a></li><li class="item-category"><a href="/fis-site/docs/api/dev.html">插件开发API</a></li><li class="item-category"><a href="/fis-sitehttps://github.com/fex-team/fis/issues/new">问题反馈</a></li><li class="item-category"><a href="/fis-sitehttps://github.com/fex-team/fis/issues?labels=faq&page=1&state=open">FAQ</a></li></ul></nav><div class="bottom-shadow"></div></aside><div class="container"><article class="doc-content"><div class="toc affix"></div><h1>插件开发</h1><p><strong>前置阅读</strong>，<em>请详细阅读以下文档，因为这些文档非常重要</em></p><ul><li><a href="http://fex-team.github.io/fis-site/docs/more/fis-base.html">编译过程运行原理</a></li><li><a href="http://fex-team.github.io/fis-site/docs/more/how-plugin-works.html">插件调用机制</a></li><li><a href="http://fex-team.github.io/fis-site/docs/more/extension-point.html">插件扩展点列表</a></li></ul><blockquote><p>注意，<strong>FIS 插件不支持异步</strong></p></blockquote><p>按照<a href="http://fex-team.github.io/fis-site/docs/more/extension-point.html">插件扩展点列表</a>文档的介绍，在整个编译流程可以扩展的点有；</p><ul><li><p>编译阶段</p><ul><li>parser</li><li>preprocessor</li><li>postprocessor</li><li>lint</li><li>test</li></ul></li><li><p>打包阶段</p><ul><li>prepackager</li><li>packager</li><li>spriter</li><li>postpackager</li></ul></li></ul><p>编译阶段，处理的是单个文件，整个过程都使用了缓存； 打包阶段，处理的是编译后的所有文件；</p><p>以上扩展点也可以理解为FIS的几类插件，接下来详细说明每一类插件自定制。</p><h2>开发插件</h2><p>FIS API</p><ul><li>fis.file file对象</li><li>fis.project project对象</li><li>fis.util util类</li><li>fis.compile 编译</li></ul><p>@see <a href="http://fex-team.github.io/fis-site/docs/api/dev.html">开发插件API</a></p><h3>编译阶段插件</h3><p><strong>插件接口</strong></p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="cm">/**
 * Compile 阶段插件接口
 * @param  {string} content     文件内容
 * @param  {File}   file        fis 的 File 对象
 * @param  {object} settings    插件配置属性
 * @return {string}             处理后的文件内容
 */</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 你在此处设置你的逻辑修改文件内容 content，或者文件对象 file</span>
    <span class="k">return</span> <span class="nx">content</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div><p>fis 的插件是以 NPM 包的形式提供的，这将意味着 fis 的插件都是一个 NPM 包，并且最终也需要发布到 NPM 平台上。为了方便管理，FIS 只能加载 NPM 全局安装的插件，这将意味着你开发的时候需要把你的插件放到 NPM 全局插件目录下。</p><p>我们如何知道这个全局插件目录在什么地方呢，一般需要通过在 CMD （Windows） 或者 终端 （类 Unix）执行命令 <code>npm prefix -g</code> 得到一个目录，比如</p><div class="highlight"><pre><code class="language-bash" data-lang="bash">➜  fis-site git:<span class="o">(</span>master<span class="o">)</span> npm prefix -g
/Users/shouding/Bin
</code></pre></div><p>那么这个全局安装的目录就是 <code>/Users/shouding/Bin/lib/node_modules</code>，在命令输出的路径后跟 <code>lib/node_modules</code>，这个就是全局安装的目录了。</p><p>Windows &amp; 类 Unix 都可以通过<strong>软链</strong>的方式把你开发插件的目录软链过去。</p><p>以下示例插件都放到 <strong>NPM 全局安装目录下</strong>，我们假定这个目录叫 <code>&lt;npm/global/path&gt;</code></p><p><strong>插件目录</strong></p><div class="highlight"><pre><code class="language-" data-lang="">&lt;npm/global/path&gt;/fis-&lt;type&gt;-&lt;name&gt;
&lt;npm/global/path&gt;/fis-&lt;type&gt;-&lt;name&gt;/index.js
</code></pre></div><ul><li><code>&lt;type&gt;</code> 插件扩展点名字</li><li><code>&lt;name&gt;</code> 插件名，只要不跟 NPM 平台上其他插件重名即可，不然无法发布上去</li></ul><p>以parser插件为例，如果使用了less、sass、coffescript等开发维护css和js。在这个阶段就是要把它们解析为标准的css和js。</p><ul><li><p>插件开发</p><p>那么我们要解析的是 sass 文件，插件扩展点为 parser，我们可以取名叫 <code>my-sass</code></p><div class="highlight"><pre><code class="language-" data-lang="">&lt;npm/global/path&gt;/fis-parser-my-sass
&lt;npm/global/path&gt;/fis-parser-my-sass/index.js
</code></pre></div><p><em>index.js</em></p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="cm">/*
 * fis
 * http://fis.baidu.com/
 */</span>

<span class="s1">'use strict'</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">sass</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'node-sass'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">settings</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">opts</span> <span class="o">=</span> <span class="nx">fis</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>
    <span class="nx">opts</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">content</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">sass</span><span class="p">.</span><span class="nx">renderSync</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>
<span class="p">};</span>

</code></pre></div></li><li><p>插件配置调用</p><p>我们开发完了 <code>fis-parser-my-sass</code>，那么改如何使用呢，如上我们就是在<code>&lt;npm/global/path&gt;</code> 目录下开发的插件，那么这时候配置调用就很简单了。</p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// vi fis-conf.js</span>
<span class="c1">// 文件后缀 .scss 的调用插件 my-sass 进行解析</span>
<span class="nx">fis</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'modules.parser.scss'</span><span class="p">,</span> <span class="s1">'my-sass'</span><span class="p">);</span>
<span class="nx">fis</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'settings.parser.my-sass'</span><span class="p">,</span> <span class="p">{</span>
    <span class="c1">// my-sass 的配置</span>
<span class="p">});</span>
<span class="nx">fis</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'roadmap.ext.scss'</span><span class="p">,</span> <span class="s1">'css'</span><span class="p">);</span> <span class="c1">// 由于 scss 文件最终会编译成 css，设置最终产出文件后缀为 css</span>
</code></pre></div></li><li><p>发布到 NPM 平台</p><p>发布 NPM 请参考，<a href="https://docs.npmjs.com/getting-started/publishing-npm-packages">https://docs.npmjs.com/getting-started/publishing-npm-packages</a></p></li></ul><h3>打包阶段插件</h3><p>如运行原理，打包阶段是多文件处理的阶段；</p><p><strong>插件接口</strong></p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="cm">/**
 * 打包阶段插件接口
 * @param  {Object} ret      一个包含处理后源码的结构
 * @param  {Object} conf     一般不需要关心，自动打包配置文件
 * @param  {Object} settings 插件配置属性
 * @param  {Object} opt      命令行参数
 * @return {undefined}          
 */</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ret</span><span class="p">,</span> <span class="nx">conf</span><span class="p">,</span> <span class="nx">settings</span><span class="p">,</span> <span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ret.src 所有的源码，结构是 {'&lt;subpath&gt;': &lt;File 对象&gt;}</span>
    <span class="c1">// ret.ids 所有源码列表，结构是 {'&lt;id&gt;': &lt;File 对象&gt;}</span>
    <span class="c1">// ret.map 如果是 spriter、postpackager 这时候已经能得到打包结果了，</span>
    <span class="c1">//         可以修改静态资源列表或者其他</span>
<span class="p">}</span>
</code></pre></div><p>以prepackager插件为例。prepackager即打包前需要对文件做某些处理，比如想在所有的html注释里面插入编译时间。</p><ul><li><p>插件开发</p><p>我们为这个插件取名叫 <code>append-build-time</code></p><div class="highlight"><pre><code class="language-" data-lang="">&lt;npm/global/path&gt;/fis-prepackager-append-build-time
&lt;npm/global/path&gt;/fis-prepackager-append-build-time/index.js
</code></pre></div><p><em>index.js</em></p><div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ret</span><span class="p">,</span> <span class="nx">conf</span><span class="p">,</span> <span class="nx">settings</span><span class="p">,</span> <span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fis</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">ret</span><span class="p">.</span><span class="nx">src</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subpath</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">isHtmlLike</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">getContent</span><span class="p">();</span>
            <span class="nx">content</span> <span class="o">+=</span> <span class="s1">'&lt;!-- build '</span><span class="o">+</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">())</span><span class="o">+</span><span class="s1">'--&gt;'</span><span class="p">;</span>
            <span class="nx">file</span><span class="p">.</span><span class="nx">setContent</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">};</span>
</code></pre></div></li><li><p>配置使用</p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// vi fis-conf.js</span>
<span class="nx">fis</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'modules.prepackager'</span><span class="p">,</span> <span class="s1">'append-build-time'</span><span class="p">);</span> <span class="c1">// packager阶段插件处理所有文件，所以不需要给某一类后缀的文件设置。</span>
<span class="nx">fis</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'settings.prepackager.append-build-time'</span><span class="p">,</span> <span class="p">{</span>
    <span class="c1">// settings</span>
<span class="p">})</span>
</code></pre></div></li><li><p>发布 NPM</p><p>发布 NPM 请参考，<a href="https://docs.npmjs.com/getting-started/publishing-npm-packages">https://docs.npmjs.com/getting-started/publishing-npm-packages</a></p></li></ul><hr><p>当然为了更快速的搞定一些小需求，可以把插件功能直接写到配置文件 <code>fis-conf.js</code> 中；</p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// vi fis-conf.js</span>
<span class="nx">fis</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'modules.postprocessor.js'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">content</span> <span class="o">+=</span> <span class="s1">'\n// build time: '</span> <span class="o">+</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div><p><strong>注意</strong></p><p>配置使用插件时，同一个扩展点可以配置多个插件，比如；</p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// 调用 fis-prepackager-a, fis-prepackager-b ...插件</span>
<span class="nx">fis</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'modules.prepackager'</span><span class="p">,</span> <span class="s1">'a,b,c,d'</span><span class="p">);</span>
<span class="c1">// or</span>
<span class="nx">fis</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'modules.prepackager'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">,</span> <span class="s1">'d'</span><span class="p">]);</span>
<span class="c1">// or</span>
<span class="nx">fis</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'modules.prepackager'</span><span class="p">,</span> <span class="p">[</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{},</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{}])</span>
</code></pre></div><h2>扩展阅读</h2><ul><li><a href="http://div.io/topic/1027">http://div.io/topic/1027</a> <code>require()</code> 源码解读</li></ul><!--  --><br><strong>有任何问题，请在 <a href="https://github.com/fex-team/fis/issues">https://github.com/fex-team/fis/issues</a> 讨论</strong></article><script type="text/javascript">$("a").each(function(t,r){0===$(r).attr("href").indexOf("/")?$(r).attr("href",""+$(r).attr("href")):0!==$(r).attr("href").indexOf("#")&&$(r).attr("target","_blank")});</script><script type="text/javascript" src="/assets/themes/js/document.js"></script></div></div><script type="text/javascript">var _bdhmProtocol="https:"==document.location.protocol?" https://":" http://";document.write(unescape("%3Cscript src='"+_bdhmProtocol+"hm.baidu.com/h.js%3F4206d67a3ea708c0d2a9354c8d88525f' type='text/javascript'%3E%3C/script%3E"));</script><!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) --><!-- Placed at the end of the document so the pages load faster --><script src="/assets/themes/js/perfect-scrollbar.min.js"></script><script type="text/javascript">!function(){function e(e,n){var i=$('<div style="display:none;"/>').appendTo($("body"));i.html("<!--[if "+(n||"")+" IE "+(e||"")+"]><a>&nbsp;</a><![endif]-->");var o=i.find("a").length;return i.remove(),o}function n(){function e(){i||(console.log("enable"),i=!0,$(".sidebar").perfectScrollbar({wheelSpeed:10,wheelPropagation:!1}))}function n(){i&&(console.log("disable"),i=!1,$(".sidebar").perfectScrollbar("destroy"))}$(window).width()>760&&$(".sidebar").height()<$(".sidebar ul").height()?e():n()}var i=!1;e(8,"lte")||($(".sidebar").addClass("scrollbar"),n(),$(window).resize(n))}();</script></body></html>